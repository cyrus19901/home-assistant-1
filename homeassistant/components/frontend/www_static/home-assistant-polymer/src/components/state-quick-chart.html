<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../../bower_components/chart.js/dist/Chart.js"></script>
<script src="../../bower_components/moment/min/moment.min.js"></script>


<dom-module id="state-quick-chart">

  <template>
    <style>
        .chart-container {
          padding: 20px;
        }
    </style>
    <div class="chart-container">
      <canvas id="canvas" width="600" height="400"></canvas>
    </div>

  </template>

</dom-module>

<script>
(function () {
  'use strict';

  Polymer({
    is: 'state-quick-chart',

    properties: {
      chartType: {
        type: String,
        value: ""
      },

      chartLabel: {
        type: String,
        value: ""
      },

      unit: {
        type: String,
      },

      isAttached: {
        type: Boolean,
        value: false
      },

      chartEngine: {
        type: Object,
      },

      _apiLoaded: {
        type: Boolean,
        value: false,
      },

      chartData: {
        type: Object,
        value: {},
        observer: 'dataChanged'
      },
    },

    created: function () {
      this.style.display = 'block';
    },

    attached: function () {
      this.isAttached = true;
    },

    dataChanged: function (chartData) {
      if (chartData)
      {
        // this.drawChart();
        switch (this.chartType)
        {
          case 'line':
            this.drawChartLine(chartData);
            break;
          case 'bar':
            this.drawChartBar(chartData);
            break;
        }
      }
    },
    drawChartLine: function (data) {
      var ctx = this.$.canvas.getContext('2d');
      var myChart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: data.times.map(function (timeStamp, index) {
                // let timeLabel = '';
                // if (index % 2 === 0)
                // {
                //   timeLabel = moment(timeStamp).format('h:mm a');
                // }
                // return timeLabel;
                return moment(timeStamp).format('h:mm a');
              }),
              datasets: [
                {
                    label: 'historical',
                    data: data.historical,
                    pointRadius: 1,
                    pointHoverRadius: 2,
                    pointBorderWidth: 0,
                    borderWidth: 2,
                    backgroundColor: '#696969',
                    borderColor: '#696969',
                    borderDash: [3,2],
                    pointStyle:'circle',
                    lineTension: 0,
                    fill: false
                },{
                    label: 'actual',
                    data: data.actual,
                    pointRadius: 1,
                    pointHoverRadius: 2,
                    pointBorderWidth: 0,
                    borderWidth: 2,
                    backgroundColor: '#FF7F50',
                    borderColor: '#FF7F50',
                    pointStyle:'circle',
                    lineTension: 0,
                    fill: false
                },{
                    label: 'transactive',
                    data: data.transactive,
                    pointRadius: 1,
                    pointHoverRadius: 2,
                    pointBorderWidth: 0,
                    borderWidth: 2,
                    backgroundColor: '#FF7F50',
                    borderColor: '#FF7F50',
                    pointStyle:'circle',
                    lineTension: 0,
                    borderDash: [3, 2],
                    fill: false
                }
              ]
          },
          options: {
            scaleShowVerticalLines: false,
              scales : {
                    xAxes : [ {
                        gridLines : {
                            display : false
                        }
                    } ]
                },
              tooltips: {
                yAlign:'top',
                xAlign:'right',
                enabled: false,
                mode: 'index',
                position: 'nearest',
                custom: this.customTooltips
              },
               animation: {
                duration: 0
             }
          }
      });
    },
    drawChartBar: function (data) {
      var ctx = this.$.canvas.getContext('2d');
      var myChart = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: data.times.map(function (timeStamp, index) {
                return moment(timeStamp).format('h:mm a');
              }),
              datasets: [
                {
                    label: 'AC1',
                    data: data.AC1,
                    pointRadius: 1,
                    pointHoverRadius: 2,
                    pointBorderWidth: 0,
                    borderWidth: 2,
                    backgroundColor: 'blue',
                    borderColor: 'blue',
                    pointStyle:'circle',
                    lineTension: 0,
                    fill: false
                },{
                    label: 'AC2',
                    data: data.AC2,
                    pointRadius: 1,
                    pointHoverRadius: 2,
                    pointBorderWidth: 0,
                    borderWidth: 2,
                    backgroundColor: 'orange',
                    borderColor: 'orange',
                    pointStyle:'circle',
                    lineTension: 0,
                    fill: false
                },{
                    label: 'WH1',
                    data: data.WH1,
                    pointRadius: 1,
                    pointHoverRadius: 2,
                    pointBorderWidth: 0,
                    borderWidth: 2,
                    backgroundColor: 'green',
                    borderColor: 'green',
                    pointStyle:'circle',
                    lineTension: 0,
                    fill: false
                }
              ]
          },
          options: {
            scaleShowVerticalLines: false,
                scales: {
                    xAxes: [{
                        stacked: true,
                        gridLines : {
                            display : false
                        }
                    }],
                    yAxes: [{
                        stacked: true
                    }]
                },
               animation: {
                duration: 0
             }
          }
      });
    },
    customTooltips: function(tooltip) {
      // remove previous tooltip if no tooltip
      if (tooltip.opacity === 0) {
        const divs = this._chart.canvas.parentNode.getElementsByTagName("div");
        
        let i = divs.length;

        for (i = divs.length - 1; i >= 0; i--)
        {
            divs[i].remove();
        }

        return;
      }

      const tooltipEl = document.createElement('div');
      tooltipEl.id = 'chartjs-tooltip';
      tooltipEl.innerHTML = "<div></div>";
      this._chart.canvas.parentNode.appendChild(tooltipEl);

      // Set caret Position
      tooltipEl.classList.remove('above', 'below', 'no-transform');
      
      if (tooltip.yAlign) 
      {
        tooltipEl.classList.add(tooltip.yAlign);
      } 
      else 
      {
        tooltipEl.classList.add('no-transform');
      }

      function getBody(bodyItem) {
        return bodyItem.lines;
      }

      // Set Text
      if (tooltip.body) {
        var titleLines = tooltip.title || [];
        var bodyLines = tooltip.body.map(getBody);

        const values = {};

        // for example, bodyLines[0] might be:
        //    ["historical: 6"]
        bodyLines.forEach(function (bodyLine) {
          const bodyParts = bodyLine[0].split(":");
          values[bodyParts[0]] = Number(bodyParts[1]);
        });

        let innerHtml = '<div>What happened at ' + titleLines + '?</div><div><div>Received incentives: $5</div>';

        if (values.actual)
        {
            innerHtml = innerHtml + '<div>Energy use: ' + values.actual + ' Kw </div><div>Outdoor Temp: 65-75 F</div>';
        }

        innerHtml = innerHtml + '<div style="font-size:11px">Ten minutes ago:<li>Energy use: ' + values.historical + ' Kw</li><li>Outdoor Temp: 55-68 F</li></div></div>';

        var bodyRoot = tooltipEl.querySelector('div');
        bodyRoot.innerHTML = innerHtml;
      }

      var positionY = this._chart.canvas.offsetTop;
      var positionX = this._chart.canvas.offsetLeft;

      // Display, position, and set styles for font
      tooltipEl.style.position = 'absolute';
      tooltipEl.style.background = '#1E90FF';
      tooltipEl.style.color = 'white';
      tooltipEl.style.padding = '5px 10px 5px 15px';
      tooltipEl.style.opacity = 1;
      tooltipEl.style.left = positionX + tooltip.caretX - 185 +'px';
      tooltipEl.style.top = positionY + tooltip.caretY - 100 + 'px';
      // tooltipEl.style.fontFamily = tooltip._fontFamily;
      tooltipEl.style.fontSize = tooltip.fontSize;
      tooltipEl.style.fontStyle = tooltip._fontStyle;
      tooltipEl.style.padding = tooltip.yPadding + 'px ' + tooltip.xPadding + 'px';
    }

  });
}());
</script>
