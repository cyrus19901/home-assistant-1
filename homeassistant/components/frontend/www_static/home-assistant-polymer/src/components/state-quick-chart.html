<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../../bower_components/chart.js/dist/Chart.js"></script>
<script src="../../bower_components/moment/min/moment.min.js"></script>


<dom-module id="state-quick-chart">

  <template>
    <style>
        .chart-container {
          padding: 20px;
        }
    </style>
    <div class="chart-container">
      <canvas id="canvas" width="600" height="400"></canvas>
    </div>

  </template>

</dom-module>

<script>
(function () {
  'use strict';

  Polymer({
    is: 'state-quick-chart',

    properties: {
      hass: {
        type: Object,
      },
      chartType: {
        type: String,
        value: ""
      },

      chartLabel: {
        type: String,
        value: ""
      },
      chartId: {
        type: String,
        value: ""
      },
      componentName: {
        type: String,
        value: ""
      },
      updateMethod: {
        type: String,
        value: ""
      },
      unit: {
        type: String,
      },

      isAttached: {
        type: Boolean,
        value: false
      },

      chartEngine: {
        type: Object,
      },

      _apiLoaded: {
        type: Boolean,
        value: false,
      },

      chartData: {
        type: Object,
        value: {},
        observer: 'dataChanged'
      },
    },

    created: function () {
      this.style.display = 'block';
    },

    attached: function () {
      this.isAttached = true;
    },

    chartTypeChanged: function (chartType) {

      const hiddenIframes = document.querySelector('.chartjs-hidden-iframe');

      if (this.chartData)
      {
        // this.drawChart();
        switch (chartType)
        {
          case 'line':
            this.drawChartLine(this.chartData);
            break;
          case 'bar':
            this.drawChartBar(this.chartData);
            break;
        }
      }
    },

    dataChanged: function (chartData) {

      if (chartData)
      {
        // this.drawChart();
        switch (this.chartType)
        {
          case 'line':
            this.drawChartLine(chartData);
            break;
          case 'bar':
            this.drawChartBar(chartData);
            break;
        }
      }
    },
    drawChartLine: function (data) {
      var ctx = this.$.canvas.getContext('2d');

      const chartObj = {
          type: 'line',
          data: {
              labels: data.times.map(function (timeStamp, index) {
                // let timeLabel = '';
                // if (index % 2 === 0)
                // {
                //   timeLabel = moment(timeStamp).format('h:mm a');
                // }
                // return timeLabel;
                return moment(timeStamp).format(data['time-format']);
              }),
              datasets: Object.keys(data.series).map(function (key, index) {

                const dataset = {
                    label: key,
                    data: data.series[key].points,
                    pointRadius: 1,
                    pointHoverRadius: 2,
                    pointBorderWidth: 0,
                    borderWidth: 2,
                    backgroundColor: (data.series[key].color ? data.series[key].color : this.colorMap(index)),
                    borderColor: (data.series[key].color ? data.series[key].color : this.colorMap(index)),
                    pointStyle:'circle',
                    lineTension: 0,
                    fill: false
                };

                if (data.series[key]['line-style'] === "dash")
                {
                  dataset.borderDash = [3,2];
                }

                return dataset;

              }, this)
          },
          options: {
              scaleShowVerticalLines: false,
              scales : {
                  xAxes : [ {
                      gridLines : {
                          display : false
                      }
                  } ]
              },
              animation: {
                  duration: 0
              }
          }
      };

      if (this.chartId == 'transactive-home')
      {
          chartObj.options.tooltips = {
            yAlign:'top',
            xAlign:'right',
            enabled: false,
            mode: 'index',
            position: 'nearest',
            intersect: 'false',
            custom: this.customTooltips
          };
      }

      var myChart = new Chart(ctx, chartObj);
    },
    drawChartBar: function (data) {
      var ctx = this.$.canvas.getContext('2d');
      var myChart = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: data.times.map(function (timeStamp, index) {
                return moment(timeStamp).format(data['time-format']);
              }),
              datasets: Object.keys(data.series).map(function (key, index) {
                return {
                    label: key,
                    data: data.series[key].points,
                    pointRadius: 1,
                    pointHoverRadius: 2,
                    pointBorderWidth: 0,
                    borderWidth: 2,
                    backgroundColor: (data.series[key].color ? data.series[key].color : this.colorMap(index)),
                    borderColor: (data.series[key].color ? data.series[key].color : this.colorMap(index)),
                    pointStyle:'circle',
                    lineTension: 0,
                    fill: false
                };
              }, this)
          },
          options: {
            scaleShowVerticalLines: false,
            scales: {
                xAxes: [{
                    stacked: true,
                    gridLines : {
                        display : false
                    }
                }],
                yAxes: [{
                    stacked: true
                }]
            },
            animation: {
                duration: 0
            },
            tooltips: {
                displayColors: true
            }
          }
      });
    },
    customTooltips: function(tooltip) {
      // remove previous tooltip if no tooltip
      if (tooltip.opacity === 0) {
        const divs = this._chart.canvas.parentNode.getElementsByTagName("div");
        
        let i = divs.length;

        for (i = divs.length - 1; i >= 0; i--)
        {
            divs[i].remove();
        }

        return;
      }

      const tooltipEl = document.createElement('div');
      tooltipEl.id = 'chartjs-tooltip';
      tooltipEl.innerHTML = "<div></div>";
      this._chart.canvas.parentNode.appendChild(tooltipEl);

      // Set caret Position
      tooltipEl.classList.remove('above', 'below', 'no-transform');
      
      if (tooltip.yAlign) 
      {
        tooltipEl.classList.add(tooltip.yAlign);
      } 
      else 
      {
        tooltipEl.classList.add('no-transform');
      }

      function getBody(bodyItem) {
        return bodyItem.lines;
      }

      // Set Text
      if (tooltip.body) {
        var titleLines = tooltip.title || [];
        var bodyLines = tooltip.body.map(getBody);

        const values = {};

        // for example, bodyLines[0] might be:
        //    ["historical: 6"]
        bodyLines.forEach(function (bodyLine) {
          const bodyParts = bodyLine[0].split(":");
          values[bodyParts[0]] = Number(bodyParts[1]);
        });

        let innerHtml = '<div>What happened at ' + titleLines + '?</div><div><div>Received incentives: $5</div>';

        if (values.actual)
        {
            innerHtml = innerHtml + '<div>Energy use: ' + values.actual + ' Kw </div><div>Outdoor Temp: 65-75 F</div>';
        }

        innerHtml = innerHtml + '<div style="font-size:11px">Ten minutes ago:<li>Energy use: ' + values.historical + ' Kw</li><li>Outdoor Temp: 55-68 F</li></div></div>';

        var bodyRoot = tooltipEl.querySelector('div');
        bodyRoot.innerHTML = innerHtml;
      }

      var positionY = this._chart.canvas.offsetTop;
      var positionX = this._chart.canvas.offsetLeft;

      // Display, position, and set styles for font
      tooltipEl.style.position = 'absolute';
      tooltipEl.style.background = '#1E90FF';
      tooltipEl.style.color = 'white';
      tooltipEl.style.padding = '5px 10px 5px 15px';
      tooltipEl.style.opacity = 1;
      tooltipEl.style.left = positionX + tooltip.caretX - 185 +'px';
      tooltipEl.style.top = positionY + tooltip.caretY - 100 + 'px';
      // tooltipEl.style.fontFamily = tooltip._fontFamily;
      tooltipEl.style.fontSize = tooltip.fontSize;
      tooltipEl.style.fontStyle = tooltip._fontStyle;
      tooltipEl.style.padding = tooltip.yPadding + 'px ' + tooltip.xPadding + 'px';
    },

  getChartType: function () {
    return

  },
  changeChartType: function (ev) {
    const value = ev.currentTarget.value;

    if (value && this.updateMethod)
    {
      const updateObj = [{ 
        'id': this.chartId,
        'target': 'type',
        'value': value 
      }];
      
      this.callServiceHelper(this.updateMethod, updateObj);
    }
  },
  colorMap: function (index) {
    
    const colors = [
      '#29A6FF', // Celestine +1
      '#E87511', // Carnelian

      '#46A661', // Olivine
      '#00AFAA', // Malachite
      '#EA82FF', // Fluorite +1

      '#FF6B70', // Cinnabar +1

      '#00BDDD', // Zircon +1
      '#AFA1FF', // Amethyst +1
      '#F5EC5A', // Topaz

      '#8CCD5A', // Peridot
      '#FFBA59', // Citrine
      '#BF2A75', // Tourmaline
    ];

    const safeIndex = (colors.length - 1) % (index + 1);

    return colors[safeIndex];
  },
  callServiceHelper: function (service, data) {
    if (this.hass && this.componentName)
    {      
      this.hass.callService(this.componentName, service, { value: data})
        .then(function () {
        }.bind(this));
    }
  },

  });
}());
</script>
